---

- name: Install OpenShift Gitops
  ansible.builtin.include_tasks: openshift_gitops.yml

- name: Install OpenShift Pipelines
  ansible.builtin.include_tasks: openshift_pipelines.yml

- name: Install NooBaa
  ansible.builtin.include_tasks: noobaa.yml

- name: Install Vault
  ansible.builtin.include_tasks: vault.yml

- name: Install External Secrets
  ansible.builtin.include_tasks: external_secrets.yml

- name: Install DevSpaces
  ansible.builtin.include_tasks: devspaces.yml

# Multiple RHDHs if cluster is defined
- name: Load cluster vars
  ansible.builtin.include_vars:
    file: "vars/{{ cluster }}.yml"
  when: cluster is defined

- name: Install Gitlab
  ansible.builtin.include_tasks: gitlab.yml

- name: Install RHBK
  ansible.builtin.include_tasks: keycloak.yml

- name: Install Quay
  ansible.builtin.include_tasks: quay.yml
  when: cluster is not defined

- name: Install RHDH GitOps
  ansible.builtin.include_tasks: rhdh_gitops.yml

# Single RHDH install if cluster is not defined
- name: Install Red Hat Developer Hub
  ansible.builtin.include_tasks: redhat_developer_hub.yml
  when: cluster is not defined
  vars:
    ocp4_workload_platform_engineering_workshop_rhdh_name: rhdh

# Multiple RHDHs if cluster is defined
- name: Install multiple Red Hat Developer Hub instances
  ansible.builtin.include_tasks: redhat_developer_hub.yml
  loop: "{{ (opencodequest.clusters | selectattr('name','equalto', cluster) | first).groups }}"
  loop_control:
    loop_var: group
  vars:
    ocp4_workload_platform_engineering_workshop_rhdh_name: "rhdh-{{ group.name }}"
    ocp4_workload_platform_engineering_workshop_rhdh_groupname: "pe{{ group.name }}"
    ocp4_workload_platform_engineering_workshop_rhdh_namespace: "rhdh-{{ group.name }}"
    ocp4_workload_platform_engineering_workshop_rhdh_argo_application_name: "rhdh-{{ group.name }}-bootstrap"
    ocp4_workload_platform_engineering_workshop_rhbk_client_backstage_name: "rhdh-{{ group.name }}"
  when: cluster is defined

- name: Install Trusted Artifact Signer
  ansible.builtin.include_tasks: trusted_artifact_signer.yml

- name: Install Sonarqube
  ansible.builtin.include_tasks: sonarqube.yml

# - name: Install Parasol
#   ansible.builtin.include_tasks: parasol.yml

# - name: Install Orchestrator
#   ansible.builtin.include_tasks: orchestrator.yml

- name: Create vault secret for stackrox
  kubernetes.core.k8s_exec:
    namespace: "{{ ocp4_workload_platform_engineering_workshop_vault_namespace }}"
    pod: vault-0
    command: "vault kv put kv/secrets/rhdh/stackrox token={{
     ocp4_workload_platform_engineering_workshop_stackrox_token }}"

- name: Create vault secret for common password
  kubernetes.core.k8s_exec:
    namespace: "{{ ocp4_workload_platform_engineering_workshop_vault_namespace }}"
    pod: vault-0
    command: "vault kv put kv/secrets/rhdh/common_password password={{
     common_password }}"


- name: Print Common Password
  agnosticd_user_info:
    msg: "{{ item }}"
  loop:
    - ""
    - "password: {{ common_password }}"
