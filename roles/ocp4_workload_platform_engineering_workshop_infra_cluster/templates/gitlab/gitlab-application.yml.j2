apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: {{ ocp4_workload_platform_engineering_workshop_gitlab_gitops_name }}
  namespace: {{ ocp4_workload_platform_engineering_workshop_gitlab_gitops_namespace }}
  finalizers:
    - resources-finalizer.argocd.argoproj.io/foreground
spec:
  destination:
    namespace: {{ ocp4_workload_platform_engineering_workshop_gitlab_namespace }}
    server: 'https://kubernetes.default.svc'
  project: default
  source:
    helm:
      values: |
        gitlab:

          templates:
            - group: rhdh
              project: template-quarkus-simple
              branch: main
              templates:
                - template.yaml
            - group: rhdh
              project: import-existing-app-template
              branch: main
              templates:
                - template.yaml
            - group: rhdh
              project: import-existing-api-template
              branch: main
              templates:
                - template.yaml
            - group: global
              project: global-techdocs
              branch: main
              templates:
                - catalog-info.yaml
                - mkdocs.yaml
            - group: rhdh
              project: template-developer-self-service
              branch: main
              templates:
                - postgres15/template.yaml
                - namespace/template-small.yaml
                - namespace/template-medium.yaml
                - namespace/template-large.yaml
            - group: rhdh
              project: orchestrator-workflows
              branch: main
              templates:
                - manifests/greeting/application.yaml
                - manifests/create-ocp-namespace-swt/application.yaml
{% for g in (opencodequest.clusters | selectattr('name','equalto', cluster) | first).groups %}
            - group: pe{{ g.name }}
              project: template-quarkus-simple
              branch: main
              templates:
                - template.yaml
            - group: pe{{ g.name }}
              project: opencodequest-templates
              branch: main
              templates:
                - scaffolder-templates/opencodequest-templates.yaml
                - scaffolder-templates/fight-ui/template.yaml
                - scaffolder-templates/quarkus-ai/template.yaml
                - scaffolder-templates/quarkus-postgresql/template.yaml
                - scaffolder-templates/quarkus-with-spring-postgresql/template.yaml
            - group: pe{{ g.name }}
              project: rhdh-entities
              branch: main
              templates:
                - systems/opencodequest-system.yaml
                - domains/domain-opencodequest.yaml
{% endfor %}

          users:
            users:
              - id: dev1
              - id: dev2
              - id: pe1
              - id: pe2
{% for g in (opencodequest.clusters | selectattr('name','equalto', cluster) | first).groups %}
{% for u in g.users %}
              - id: {{ u }}-pe
              - id: {{ u }}-dev
{% endfor %}
{% endfor %}
            password: 

          groups:
            # --- static groups ---
            - name: devteam
              repo: []
              users:
                - id: dev1
                - id: dev2

            - name: global
              repo:
                - name: global-techdocs
                  url: https://github.com/rh-opencodequest-origins/global-techdocs.git
              users:
                - id: dev1
                - id: dev2
                - id: pe1
                - id: pe2

            - name: rhdh
              repo:
                - name: template-quarkus-simple
                  url: https://github.com/rh-opencodequest-origins/rhdh-template-quarkus-simple.git
                - name: parasol-store-dev-template
                  url: https://github.com/rh-opencodequest-origins/parasol-store-dev-templates.git
                - name: developer-hub-config
                  url: https://github.com/rh-opencodequest-origins/developer-hub-config.git
                - name: import-existing-app-template
                  url: https://github.com/rh-opencodequest-origins/import-existing-app-template.git
                - name: import-existing-api-template
                  url: https://github.com/rh-opencodequest-origins/import-api-template.git
                - name: rhdh-entities
                  url: https://github.com/rh-opencodequest-origins/pe-workshop-entities.git
                - name: template-developer-self-service
                  url: https://github.com/rh-opencodequest-origins/rhdh-template-developer-self-service.git
                - name: orchestrator-workflows
                  url: https://github.com/rh-opencodequest-origins/orchestrator-workflows.git
              users:
                - id: pe1
                - id: pe2
              project:
                - name: rhdh-issues
                  labels:
                    - name: approved
                      color: green
                    - name: denied
                      color: red
            # --- dynamic groups from cluster vars ---
{% for g in (opencodequest.clusters | selectattr('name','equalto', cluster) | first).groups %}
            - name: pe{{ g.name }}
              repo:
                - name: template-quarkus-simple
                  url: https://github.com/rh-opencodequest-origins/rhdh-template-quarkus-simple.git
                - name: parasol-store-dev-template
                  url: https://github.com/rh-opencodequest-origins/parasol-store-dev-templates.git
                - name: developer-hub-config
                  url: https://github.com/rh-opencodequest-origins/developer-hub-config.git
                - name: import-existing-app-template
                  url: https://github.com/rh-opencodequest-origins/import-existing-app-template.git
                - name: import-existing-api-template
                  url: https://github.com/rh-opencodequest-origins/import-api-template.git
                - name: rhdh-entities
                  url: https://github.com/rh-opencodequest-origins/pe-workshop-entities.git
                - name: template-developer-self-service
                  url: https://github.com/rh-opencodequest-origins/rhdh-template-developer-self-service.git
                - name: orchestrator-workflows
                  url: https://github.com/rh-opencodequest-origins/orchestrator-workflows.git
                - name: opencodequest-templates
                  url: https://github.com/rh-opencodequest-origins/opencodequest-templates.git
              users:
{% for u in g.users %}
                - id: {{ u }}-pe
{% endfor %}
              project:
                - name: rhdh-issues
                  labels:
                    - name: approved
                      color: green
                    - name: denied
                      color: red
{% endfor %}

{% for g in (opencodequest.clusters | selectattr('name','equalto', cluster) | first).groups %}
            - name: dev{{ g.name }}
              repo: [] 
              users:
{% for u in g.users %}
                - id: {{ u }}-dev
{% endfor %}

              project:
                - name: rhdh-issues
                  labels:
                    - name: approved
                      color: green
                    - name: denied
                      color: red
{% endfor %}



      parameters:
        - name: gitlab.smtp.host
          value: "{{ ocp4_workload_platform_engineering_workshop_gitlab_config_smtp_host }}"
        - name: gitlab.ssh.host
          value: "{{ ocp4_workload_platform_engineering_workshop_gitlab_config_ssh_host }}"
        - name: gitlab.rootPassword
          value: "{{ ocp4_workload_platform_engineering_workshop_gitlab_config_root_password }}"
        - name: gitlab.users.password
          value: "{{ ocp4_workload_platform_engineering_workshop_gitlab_users_password }}"
        - name: gitlab.host
          value: {{ ocp4_workload_platform_engineering_workshop_gitlab_config_host }}
        - name: cluster.subdomain
          value: {{ r_openshift_subdomain }}
        - name: gitops.namespace
          value: {{ ocp4_workload_platform_engineering_workshop_rhdh_gitops_namespace }}
        - name: quay.host
          value: {{ ocp4_workload_platform_engineering_workshop_quay_registry_host }}
        - name: vault.name
          value: {{ ocp4_workload_platform_engineering_workshop_vault_name }}
        - name: vault.namespace
          value: {{ ocp4_workload_platform_engineering_workshop_vault_namespace }}
        - name: orchestrator.namespace
          value: {{ ocp4_workload_platform_engineering_workshop_orchestrator_namespace }}
    path: {{ ocp4_workload_platform_engineering_workshop_gitlab_gitops_repo_path }}
    repoURL: {{ ocp4_workload_platform_engineering_workshop_gitlab_gitops_repo }}
    targetRevision: {{ ocp4_workload_platform_engineering_workshop_gitlab_gitops_repo_tag }}
  syncPolicy:
    automated: {}
    retry:
      backoff:
        duration: 5s
        factor: 2
        maxDuration: 3m0s
      limit: 2
    syncOptions:
      - CreateNamespace=true
      - RespectIgnoreDifferences=true